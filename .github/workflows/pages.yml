name: Deploy GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'readme.md'
      - 'CHANGELOG.md'
      - 'SECURITY.md'
      - 'CONTRIBUTING.md'
      - 'CODE_OF_CONDUCT.md'
      - 'DEVELOPMENT.md'
      - 'static/png/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v5
      
      - name: Build website
        run: |
          # Debug: List available files
          echo "📁 Available files:"
          ls -la static/ || echo "static/ directory not found"
          ls -la static/png/ || echo "static/png/ directory not found"
          
          # Create assets directory
          mkdir -p docs/assets
          
          # Copy favicon and logo if they exist
          if [ -f "static/png/favicon.png" ]; then
            cp static/png/favicon.png docs/assets/favicon.png
            echo "✅ Favicon copied ($(stat -c%s static/png/favicon.png) bytes)"
          else
            echo "⚠️  Favicon not found, skipping"
          fi
          
          if [ -f "static/png/logo.png" ]; then
            cp static/png/logo.png docs/assets/logo.png
            echo "✅ Logo copied ($(stat -c%s static/png/logo.png) bytes)"
            echo "📁 Logo file details:"
            ls -la docs/assets/logo.png || echo "Logo copy failed"
          else
            echo "⚠️  Logo not found, skipping"
          fi
          
          # Create a simple sitemap
          cat > docs/sitemap.xml << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://qballjos.github.io/docker-template-manager/</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
          </urlset>
          EOF
          
          # Create robots.txt
          cat > docs/robots.txt << EOF
          User-agent: *
          Allow: /
          
          Sitemap: https://qballjos.github.io/docker-template-manager/sitemap.xml
          EOF
          
          # Verify docs directory structure
          echo "📁 Final docs directory structure:"
          ls -la docs/
          echo "📄 docs/index.html exists: $([ -f docs/index.html ] && echo 'YES' || echo 'NO')"
          
          echo "✅ Website built successfully"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
